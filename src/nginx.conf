# Nginx Configuration for Sewercide CTF Challenge
#
# DEPLOYMENT CONTEXT:
# This configuration file is deployed by Deputy as part of the sewercide-ctf package.
# It's copied to /tmp/sewercide-setup/nginx.conf during VM provisioning.
#
# ACTIVATION:
# Nginx is pre-installed but DISABLED on the ubuntu2404-base-web base image.
# The install.sh script:
# 1. Copies this file to /etc/nginx/sites-enabled/sewercide
# 2. Removes the default site configuration
# 3. Replaces PHP_VERSION_PLACEHOLDER with actual PHP version (e.g., php8.3)
# 4. Enables and starts nginx service via systemd
#
# WEB APPLICATION:
# Serves the vulnerable Sewercide Plumbing web application on port 8080.
# Application runs as 'webmaster' user (configured in PHP-FPM pool).
#
# SECURITY NOTE:
# This is a CTF challenge with intentional vulnerabilities. The web application
# contains an argument injection flaw in the pricing form handler.

server {
    listen 8080;        # Port 8080 (non-standard to require reconnaissance)
    server_name _;      # Accept any hostname

    root /var/www/sewercide/www;    # Web application root directory
    index index.php;                # Default index file

    # Logging configuration
    access_log /var/log/nginx/sewercide_access.log;    # HTTP request log
    error_log /var/log/nginx/sewercide_error.log;      # Error and debug log

    # Static files location (CSS, JS, images)
    # Served directly by nginx without PHP processing
    location /static/ {
        alias /var/www/sewercide/www/static/;
        autoindex off;    # Don't show directory listings
    }

    # Main location block - handles all requests
    # Routes requests to index.php if file doesn't exist
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP processing via FastCGI Process Manager (PHP-FPM)
    # All .php files are passed to PHP-FPM for execution
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        # PHP-FPM socket - placeholder replaced by install.sh with actual version
        fastcgi_pass unix:/var/run/php/PHP_VERSION_PLACEHOLDER-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # Security: Deny access to hidden files and directories
    # Prevents access to .git, .env, .htaccess, etc.
    location ~ /\. {
        deny all;              # Return 403 Forbidden
        access_log off;        # Don't log these attempts
        log_not_found off;     # Don't log 404s for hidden files
    }
}
